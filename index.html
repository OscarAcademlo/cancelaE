<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Turnos Médicos</title>
    <!-- Vinculación de Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABQqEXR6sbX7HOnGpL4p6u5+HYzj0Xl1Z9zRlGm/e0pX1omVijg9V5p" crossorigin="anonymous">
    <style>
        body {
            padding: 20px;
            background-color: #f4f7f6;
        }
        .card {
            margin: 10px 0;
        }
        .card-header {
            background-color: #007bff;
            color: #fff;
            text-align: center;
        }
        .btn {
            margin-top: 10px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .form-group {
            margin-bottom: 15px;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1 class="text-center my-4">Gestión de Turnos Médicos</h1>

        <!-- Formulario para cargar archivo, seleccionar fecha y médico -->
        <div class="row">
            <div class="col-md-4">
                <div class="form-group">
                    <label for="excel-file">Cargar archivo Excel (.xlsx):</label>
                    <input type="file" id="excel-file" class="form-control" />
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-group">
                    <label for="fecha">Seleccionar Fecha:</label>
                    <input type="date" id="fecha" class="form-control" />
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-group">
                    <label for="medico">Seleccionar Médico:</label>
                    <select id="medico" class="form-control">
                        <option value="">Seleccione un Médico</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Mostrar los turnos -->
        <div id="turnos" class="row mt-4"></div>
    </div>

    <!-- Cargar la librería de ExcelJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js" integrity="sha512-dlPw+ytv/6JyepmelABrgeYgHI0O+frEwgfnPdXDTOIZz+eDgfW07QXG02/O8COfivBdGNINy+Vex+lYmJ5rxw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    
    <script>
        let turnos = [];
        let medicos = [];

        // Función para leer archivo Excel usando ExcelJS
        function leerExcel(event) {
            const file = event.target.files[0];

            if (file) {
                const reader = new FileReader();

                reader.onload = function(e) {
                    const data = e.target.result;

                    // Usamos ExcelJS para leer el archivo
                    const workbook = new ExcelJS.Workbook();
                    workbook.xlsx.load(data).then(function() {
                        const worksheet = workbook.worksheets[0]; // Primer hoja
                        const jsonData = [];

                        worksheet.eachRow({ includeEmpty: true }, function(row, rowNumber) {
                            // Salteamos la primera fila (encabezados)
                            if (rowNumber > 1) {
                                const rowData = row.values;
                                let fechaTurno = rowData[7]; // Fecha del Turno (suponiendo que es la columna 7)
                                let horaTurno = rowData[6]; // Hora del Turno (suponiendo que es la columna 6)

                                // Si la fecha incluye hora, podemos extraer la parte relevante
                                if (fechaTurno instanceof Date) {
                                    fechaTurno = fechaTurno.toISOString().split('T')[0]; // Solo la fecha
                                }

                                // Convertir la hora a un formato de 24 horas
                                if (horaTurno instanceof Date) {
                                    horaTurno = horaTurno.toLocaleTimeString('en-GB'); // Obtiene la hora en formato 24h
                                }

                                jsonData.push({
                                    Médico: rowData[1],       // Médico
                                    Nombre: rowData[2],       // Nombre
                                    Apellido: rowData[3],     // Apellido
                                    DNI: rowData[4],          // DNI
                                    'Teléfono WhatsApp': rowData[5], // Teléfono WhatsApp
                                    'Hora del Turno': horaTurno,    // Hora del Turno
                                    'Fecha del Turno': fechaTurno    // Fecha del Turno
                                });

                                // Agregar el médico al listado (sin duplicados)
                                if (!medicos.includes(rowData[1])) {
                                    medicos.push(rowData[1]);
                                }
                            }
                        });

                        // Mapear los datos
                        turnos = jsonData;
                        console.log("Datos cargados desde Excel:", turnos); // Verificar los datos cargados

                        // Llenar el select de médicos
                        llenarSelectMedicos();

                        // Mostrar los turnos
                        mostrarTurnos();
                    });
                };

                reader.readAsArrayBuffer(file);
            } else {
                alert("No se seleccionó ningún archivo.");
            }
        }

        // Función para llenar el select de médicos
        function llenarSelectMedicos() {
            const selectMedico = document.getElementById("medico");
            medicos.forEach(medico => {
                const option = document.createElement("option");
                option.value = medico;
                option.textContent = medico;
                selectMedico.appendChild(option);
            });
        }

        // Función para mostrar los turnos
        function mostrarTurnos() {
            const fecha = document.getElementById("fecha").value;
            const medicoSeleccionado = document.getElementById("medico").value;

            // Verificar si ambos, fecha y médico, están seleccionados
            if (!fecha || !medicoSeleccionado) {
                document.getElementById("turnos").innerHTML = '';  // Limpiar los turnos si faltan los datos
                return;  // No mostrar nada si falta algún dato
            }

            console.log("Fecha seleccionada:", fecha);
            console.log("Médico seleccionado:", medicoSeleccionado);

            // Filtrar turnos por fecha y médico
            const turnosFiltrados = turnos.filter(turno => {
                return turno['Fecha del Turno'] === fecha && turno.Médico === medicoSeleccionado;
            });

            const turnosContainer = document.getElementById("turnos");
            turnosContainer.innerHTML = '';  // Limpiar el contenedor antes de agregar los nuevos turnos

            if (turnosFiltrados.length === 0) {
                turnosContainer.innerHTML = `<p class="text-center">No hay turnos para la fecha y médico seleccionados.</p>`;
            }

            turnosFiltrados.forEach(turno => {
                const card = document.createElement('div');
                card.classList.add('col-md-4');
                card.classList.add('card');
                card.classList.add('shadow-sm');
                card.innerHTML = `
                    <div class="card-header">
                        <h4 class="card-title">${turno.Médico}</h4>
                    </div>
                    <div class="card-body">
                        <h5 class="card-text">${turno.Nombre} ${turno.Apellido}</h5>
                        <p class="card-text">DNI: ${turno.DNI}</p>
                        <p class="card-text">Hora: ${turno['Hora del Turno']}</p>
                        <p class="card-text">Teléfono WhatsApp: ${turno['Teléfono WhatsApp']}</p>
                        <button class="btn btn-success" onclick="enviarMensaje('${turno['Teléfono WhatsApp']}')">Enviar mensaje</button>
                        <button class="btn btn-primary" onclick="llamar('${turno['Teléfono WhatsApp']}')">Llamar</button>
                    </div>
                `;
                turnosContainer.appendChild(card);
            });
        }

        // Función para enviar mensaje (usar WhatsApp API)
        function enviarMensaje(telefono) {
            window.open(`https://wa.me/${telefono}`, '_blank');
        }

        // Función para llamar
        function llamar(telefono) {
            window.location.href = `tel:${telefono}`;
        }

        // Event listeners para cargar el archivo y mostrar los turnos
        document.getElementById("excel-file").addEventListener("change", leerExcel);
        document.getElementById("fecha").addEventListener("change", mostrarTurnos);
        document.getElementById("medico").addEventListener("change", mostrarTurnos);
    </script>

</body>
</html>
